<!DOCTYPE html>

<head>
    <title>sp001test</title>
    <style>
    .container {
        width: 80%;
    }

    #waveform {
        width: 80%;
        display: inline-block;
    }
    </style>
    <!-- https://datatables.net/download/ -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/jq-3.2.1/dt-1.10.16/b-1.5.1/b-html5-1.5.1/fh-3.1.3/kt-2.3.2/sc-1.4.4/sl-1.2.5/datatables.min.css" />
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/jq-3.2.1/dt-1.10.16/b-1.5.1/b-html5-1.5.1/fh-3.1.3/kt-2.3.2/sc-1.4.4/sl-1.2.5/datatables.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/2.0.5/wavesurfer.js"></script>
    <!-- wavesurfer.js regions -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/2.0.5/plugin/wavesurfer.regions.min.js"></script>
    <script src="js/keyboard.js"></script>
</head>

<body>
    <div>
        <div id="waveform"></div>
        <audio id="audio" preload="auto" onload="showWaveForm()">
            <source src="audio/sp001test.mp4" type="audio/mpeg">
            <track id="trk" onload="showTracks()" kind="subtitles" srclang="es" src="vtt/sp0011test.vtt" default />
        </audio>
        <span id="currentTime">0</span>/<span id="currentDuration">0</span>
        <div>Zoom:
            <input id="zoom" type="range" min="1" max="200" value="1" /> Rate:
            <input id="rate" type="range" min=".25" max="4" value="1" />
        </div>
    </div>
    <div class="container">
        <table id="table_id" class="display compact" style="width:100%">
            <thead>
                <tr>
                    <th>index</th>
                    <th>es</th>
                    <th>starttime</th>
                    <th>endtime</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <script type="text/javascript">
    //var audio = document.getElementById('audio');
    var track = document.getElementById('trk');
    var textTrack = track.track;

    function showWaveForm() {
        wavesurfer = WaveSurfer.create({
            container: '#waveform',
            height: 64,
            responsive: true,
            waveColor: 'violet',
            progressColor: 'purple',
            backend: 'MediaElement',
            plugins: [
                WaveSurfer.regions.create({
                    dragSelection: {
                        slop: 50
                    }
                })
            ]
        });
        wavesurfer.load('audio/sp001test.mp4');

        var zoom = document.querySelector('#zoom');

        zoom.oninput = function() {
            var zoomLevel = Number(zoom.value);
            wavesurfer.zoom(zoomLevel);
        };

        var rate = document.querySelector('#rate');

        rate.oninput = function() {
            var rateLevel = Number(rate.value);
            wavesurfer.setPlaybackRate(rateLevel);
        };
    }
    showWaveForm()

    var t = null;

    function showTracks() {
        var cues = textTrack.cues;
        start = 0;
        for (let i = 0; i < cues.length; i++) {
            start = cues[i].startTime;
            end = cues[i].endTime;
            text = cues[i].text;
            t.row.add([
                i,
                text,
                start,
                end
            ]).draw(false);
        }
        t.columns.adjust();;

    }

    wavesurfer.on('region-update-end', function(r) {
        //let track = findTrack(r.start);

        var cues = textTrack.cues;
        cues[r.id].startTime = r.start;
        cues[r.id].endTime = r.end;
        console.log(cues[r.id], r);


    });
    wavesurfer.on('seek', function(p) {
        console.log('p', p);
        let t = p * wavesurfer.getDuration();
        let currentTrackNum = findTrack(wavesurfer.getCurrentTime());
        if (currentTrackNum) {
            var cues = textTrack.cues;

            let start = cues[currentTrackNum].startTime;
            let end = cues[currentTrackNum].endTime;

            wavesurfer.play(start, end);
            //e.shiftKey ? wavesurfer.play(data[2]): wavesurfer.play(data[2],data[3]);
        } else {
            wavesurfer.play(t);
        }
    });
    wavesurfer.on('ready', function() {
        $('#currentTime').text(wavesurfer.getCurrentTime().toFixed(3));
    });

    function findTrack(t) {
        //Given a current time, returns the track number, or null if none.
        var cues = textTrack.cues;
        start = 0;
        for (let i = 0; i < cues.length; i++) {
            if (t >= cues[i].startTime && t <= cues[i].endTime) return i;
        }
        return null;
    }

    wavesurfer.on('audioprocess', function() {

        $('#currentTime').text(wavesurfer.getCurrentTime().toFixed(3));
        $('#currentDuration').text(wavesurfer.getDuration().toFixed(3));
        wavesurfer.clearRegions();
        let currentTrackNum = findTrack(wavesurfer.getCurrentTime());
        if (currentTrackNum) {
            var cues = textTrack.cues;
            wavesurfer.addRegion({
                start: cues[currentTrackNum].startTime,
                end: cues[currentTrackNum].endTime,
                id: currentTrackNum,
                color: 'rgba(128,0,0,.5)',
                drag: false,
                resize: true
            });
        }
    });

    $(document).ready(function() {
        t = $('#table_id').DataTable({
            "paging": false
        });


        $('#table_id tbody').on('click', 'tr', function(e) {


            var data = t.row(this).data();
            e.shiftKey ? wavesurfer.play(data[2]) : wavesurfer.play(data[2], data[3]);
        });

    });
    </script>
</body>

</html>