<!DOCTYPE html>

<head>
    <title>sp001test</title>
    <!--   <style type="text/css">
    html,
    body {
        padding: 0;
        margin: 0;
        width: 100%;
        min-height: 100%;
        background-color: #000;
        color: #f0f;
    }

    #lyrics {
        margin-left: 3em;
        font: 700 2.3em arial, sans-serif;
        color: #0ff;
        text-align: center;
    }
    </style> -->
    <style>
    .container {
        width: 80%;
    }
    #waveform{
    	width:30%;
    	display: inline-block;
    }
    </style>
    <!-- https://datatables.net/download/ -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/jq-3.2.1/dt-1.10.16/b-1.5.1/b-html5-1.5.1/fh-3.1.3/kt-2.3.2/sc-1.4.4/sl-1.2.5/datatables.min.css" />
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/jq-3.2.1/dt-1.10.16/b-1.5.1/b-html5-1.5.1/fh-3.1.3/kt-2.3.2/sc-1.4.4/sl-1.2.5/datatables.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/2.0.5/wavesurfer.js"></script>
</head>

<body>
	<div>
	<div id="waveform"></div>

    <audio id="audio" preload="auto" onload="showWaveForm()">
        <source src="audio/sp001test.mp4" type="audio/mpeg">
        <track id="trk" onload="showTracks()" kind="subtitles" srclang="es" src="vtt/sp0011test.vtt" default />
    </audio>
    <span id="currentTime">0</span>    
         <div><input id="slider" type="range" min="1" max="200" value="1" style="width: 100%/></div>
    </div>
    <div class="container">
        <table id="table_id" class="display compact" style="width:100%">
            <thead>
                <tr>
                    <th>index</th>
                    <th>passage</th>
                    <th>starttime</th>
                    <th>endtime</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <script type="text/javascript">
    var lyrics = document.getElementById('lyrics');
    //var audio = document.getElementById('audio');
    var track = document.getElementById('trk');
    var textTrack = track.track;
    track.addEventListener("cuechange", cueChange, false);

    function cueChange() {
        var cues = textTrack.activeCues;
    }

    function showWaveForm() {
         wavesurfer = WaveSurfer.create({
            container: '#waveform',
            waveColor: 'violet',
            progressColor: 'purple',
            backend: 'MediaElement'
        });
        wavesurfer.load('audio/sp001test.mp4');

        var slider = document.querySelector('#slider');

        slider.oninput = function () {
          var zoomLevel = Number(slider.value);
          wavesurfer.zoom(zoomLevel);
        };
    }
    showWaveForm()

    function dokeydown(e) {
        if (e.key == "j") {
            var cues = textTrack.cues;
            start = 0;
            for (let i = 0; i < cues.length; i++) {
                if (cues[i].startTime < wavesurfer.getCurrentTime()) {
                    start = cues[i].startTime;
                    end = cues[i].endTime;

                } else {
                    wavesurfer.play(start,end);
                    break;
                }
            }
        }
        if (e.key == "l") wavesurfer.setCurrentTime(wavesurfer.getCurrentTime()+5);
       // if (e.key == "j") wavesurfer.setCurrentTime(wavesurfer.getCurrentTime()-5);
        if (e.key == "k") wavesurfer.playPause();
        if (e.key == "5") wavesurfer.setPlaybackRate(1);
        if (e.key == "4") wavesurfer.setPlaybackRate(.75);
        if (e.key == "3") wavesurfer.setPlaybackRate(.5);
        if (e.key == "6") wavesurfer.setPlaybackRate(1.5);
        if (e.key == "7") wavesurfer.setPlaybackRate(2);

        e.stopPropagation();
    }
    var t = null;

    function showTracks() {
        var cues = textTrack.cues;
        start = 0;
        for (let i = 0; i < cues.length; i++) {
            start = cues[i].startTime;
            end = cues[i].endTime;
            text = cues[i].text;
            // console.log(i, start, end, text);
            t.row.add([
                i,
                text,
                start,
                end
            ]).draw(false);
        }
        t.columns.adjust();;
 
    }

     wavesurfer.on('ready', function () {
        $('#currentTime').text(wavesurfer.getCurrentTime().toFixed(3));
    });
    wavesurfer.on('audioprocess', function () {
        $('#currentTime').text(wavesurfer.getCurrentTime().toFixed(3));
    });

    document.addEventListener("keydown", dokeydown);
    $(document).ready(function() {
        t = $('#table_id').DataTable({
            "paging": false
        });


        $('#table_id tbody').on('click', 'tr', function(e) {
            var data = t.row(this).data();
            e.shiftKey ? wavesurfer.play(data[2]): wavesurfer.play(data[2],data[3]);
        });

    });


    </script>
</body>

</html>